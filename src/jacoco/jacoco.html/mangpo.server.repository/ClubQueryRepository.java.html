<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ClubQueryRepository.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">server</a> &gt; <a href="index.source.html" class="el_package">mangpo.server.repository</a> &gt; <span class="el_source">ClubQueryRepository.java</span></div><h1>ClubQueryRepository.java</h1><pre class="source lang-java linenums">package mangpo.server.repository;

import com.querydsl.core.Tuple;
import com.querydsl.jpa.JPAExpressions;
import com.querydsl.jpa.impl.JPAQueryFactory;
import lombok.Data;
import lombok.extern.slf4j.Slf4j;
import mangpo.server.entity.*;
import mangpo.server.entity.post.Post;
import mangpo.server.entity.user.User;
import org.springframework.format.annotation.DateTimeFormat;
import org.springframework.stereotype.Repository;

import javax.persistence.EntityManager;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.stream.Collectors;

import static mangpo.server.entity.QClubBookUser.clubBookUser;
import static mangpo.server.entity.QLiked.liked;
import static mangpo.server.entity.book.QBook.book;
import static mangpo.server.entity.post.QComment.comment;
import static mangpo.server.entity.post.QPost.post;

<span class="nc" id="L27">@Slf4j</span>
@Repository
public class ClubQueryRepository {


    private final JPAQueryFactory queryFactory;

<span class="nc" id="L34">    public ClubQueryRepository(EntityManager em) {</span>
<span class="nc" id="L35">        this.queryFactory = new JPAQueryFactory(em);</span>
<span class="nc" id="L36">    }</span>

    public List&lt;Club&gt; findDistinctClub(User userRequest) {
<span class="nc" id="L39">        return queryFactory</span>
<span class="nc" id="L40">                .select(clubBookUser.club).distinct()</span>
<span class="nc" id="L41">                .from(clubBookUser)</span>
<span class="nc" id="L42">                .where(clubBookUser.club.isNotNull(), clubBookUser.user.eq(userRequest))</span>
<span class="nc" id="L43">                .fetch();</span>

    }

    public List&lt;Post&gt; findTrendingPostByClub(Club clubRequest, int memberSize) {

//        List&lt;Book&gt; books = queryFactory
//                .select(book)
//                .from(clubBookUser)
//                .join(clubBookUser.book, book)
//                .where(clubBookUser.club.eq(clubRequest),
//                        clubBookUser.book.isNotNull(),
//                        clubBookUser.user.isNotNull())
//                .fetch();

<span class="nc" id="L58">        SaveTime saveTime = new SaveTime();</span>
<span class="nc" id="L59">        saveTime.setSearchEndDate( LocalDateTime.now());</span>
<span class="nc" id="L60">        saveTime.setSearchStartDate(LocalDateTime.now().minusWeeks(2));</span>

<span class="nc" id="L62">        log.info(&quot;searchStartDate={}&quot;,  saveTime.getSearchStartDate());</span>
<span class="nc" id="L63">        log.info(&quot;searchEndDate={}&quot;, saveTime.getSearchEndDate());</span>


//        List&lt;Post&gt; posts = queryFactory
//                .select(post)
//                .from(post)
//                .where(post.createdDate.between(SaveTime.searchStartDate, SaveTime.searchEndDate),
//                        post.type.eq(PostType.MEMO),
//                        post.book.in(books))
//                .fetch();

<span class="nc" id="L74">        List&lt;Post&gt; posts = queryFactory</span>
<span class="nc" id="L75">                .select(post)</span>
<span class="nc" id="L76">                .from(post)</span>
<span class="nc" id="L77">                .where(post.createdDate.between(saveTime.getSearchStartDate(), saveTime.getSearchEndDate()),</span>
<span class="nc" id="L78">                        post.book.in(JPAExpressions</span>
<span class="nc" id="L79">                                .select(book)</span>
<span class="nc" id="L80">                                .from(clubBookUser)</span>
<span class="nc" id="L81">                                .join(clubBookUser.book, book)</span>
<span class="nc" id="L82">                                .where(clubBookUser.club.eq(clubRequest),</span>
<span class="nc" id="L83">                                        clubBookUser.book.isNotNull(),</span>
<span class="nc" id="L84">                                        clubBookUser.user.isNotNull())))</span>
<span class="nc" id="L85">                .fetch();</span>

<span class="nc" id="L87">        log.info(&quot;posts={}&quot;,  posts);</span>

<span class="nc" id="L89">        List&lt;Tuple&gt; likedList = queryFactory</span>
<span class="nc" id="L90">                .select(liked.post, liked.count())</span>
<span class="nc" id="L91">                .from(liked).distinct()</span>
<span class="nc" id="L92">                .join(liked.post, post)</span>
<span class="nc" id="L93">                .where(liked.post.in(posts))</span>
<span class="nc" id="L94">                .groupBy(liked.post)</span>
<span class="nc" id="L95">                .fetch();</span>

<span class="nc" id="L97">        log.info(&quot;likedList={}&quot;,  likedList);</span>

<span class="nc" id="L99">        List&lt;Tuple&gt; comments = queryFactory</span>
<span class="nc" id="L100">                .select(comment.post, comment.count())</span>
<span class="nc" id="L101">                .from(comment).distinct()</span>
<span class="nc" id="L102">                .join(comment.post, post)</span>
<span class="nc" id="L103">                .where(comment.post.in(posts))</span>
<span class="nc" id="L104">                .groupBy(comment.post)</span>
<span class="nc" id="L105">                .fetch();</span>
<span class="nc" id="L106">        log.info(&quot;comments={}&quot;,  comments);</span>



<span class="nc" id="L110">        double memberCeil = Math.ceil(memberSize / 2.0);</span>

<span class="nc" id="L112">        List&lt;Post&gt; postFilteredFromLikedList = likedList.stream()</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                .filter(m -&gt; m.get(liked.count()) &gt;= memberCeil)</span>
<span class="nc" id="L114">                .map(m -&gt; m.get(liked.post))</span>
<span class="nc" id="L115">                .collect(Collectors.toList());</span>
<span class="nc" id="L116">        log.info(&quot;postFilteredFromLikedList={}&quot;,  postFilteredFromLikedList);</span>

<span class="nc" id="L118">        List&lt;Post&gt; postFilteredFromComments = comments.stream()</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">                .filter(m -&gt; m.get(comment.count()) &gt;= memberSize * 2L)</span>
<span class="nc" id="L120">                .map(m -&gt; m.get(comment.post))</span>
<span class="nc" id="L121">                .collect(Collectors.toList());</span>
<span class="nc" id="L122">        log.info(&quot;postFilteredFromComments={}&quot;,  postFilteredFromComments);</span>

<span class="nc" id="L124">        List&lt;Post&gt; intersection = postFilteredFromLikedList.stream()</span>
<span class="nc" id="L125">                .filter(postFilteredFromComments::contains)</span>
<span class="nc" id="L126">                .collect(Collectors.toList());</span>
<span class="nc" id="L127">        log.info(&quot;intersection={}&quot;,  intersection);</span>

<span class="nc bnc" id="L129" title="All 2 branches missed.">        if (intersection.size() &gt; 3) {</span>
<span class="nc" id="L130">            Collections.shuffle(intersection);</span>
<span class="nc" id="L131">            List&lt;Post&gt; result = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L132">            result.add(intersection.get(0));</span>
<span class="nc" id="L133">            result.add(intersection.get(1));</span>
<span class="nc" id="L134">            result.add(intersection.get(2));</span>
<span class="nc" id="L135">            log.info(&quot;result={}&quot;,  result);</span>

<span class="nc" id="L137">            return result;</span>
        }
//        log.info(&quot;intersection={}&quot;,  intersection);
//        log.info(&quot;intersectionGetId={}&quot;,  intersection.get(0).getId());

<span class="nc" id="L142">        return intersection;</span>
    }

//    public List&lt;Post&gt; findHotMemoByClub(Club clubRequest,int memberSize) {
//
////        List&lt;Book&gt; books = queryFactory
////                .select(book)
////                .from(clubBookUser)
////                .join(clubBookUser.book, book)
////                .where(clubBookUser.club.eq(clubRequest),
////                        clubBookUser.book.isNotNull(),
////                        clubBookUser.user.isNotNull())
////                .fetch();
//
//        SaveTime saveTime = new SaveTime();
//        saveTime.setSearchEndDate( LocalDateTime.now());
//        saveTime.setSearchStartDate(LocalDateTime.now().minusWeeks(2));
//
//        log.info(&quot;searchStartDate={}&quot;,  saveTime.getSearchStartDate());
//        log.info(&quot;searchEndDate={}&quot;, saveTime.getSearchEndDate());
//
//
////        List&lt;Post&gt; posts = queryFactory
////                .select(post)
////                .from(post)
////                .where(post.createdDate.between(SaveTime.searchStartDate, SaveTime.searchEndDate),
////                        post.type.eq(PostType.MEMO),
////                        post.book.in(books))
////                .fetch();
//
//        List&lt;Post&gt; posts = queryFactory
//                .select(post)
//                .from(post)
//                .where(post.createdDate.between(saveTime.getSearchStartDate(), saveTime.getSearchEndDate()),
//                        post.type.eq(PostType.MEMO),
//                        post.book.in(JPAExpressions
//                                .select(book)
//                                .from(clubBookUser)
//                                .join(clubBookUser.book, book)
//                                .where(clubBookUser.club.eq(clubRequest),
//                                        clubBookUser.book.isNotNull(),
//                                        clubBookUser.user.isNotNull())))
//                .fetch();
//
//        log.info(&quot;posts={}&quot;,  posts);
//
//        List&lt;Tuple&gt; likedList = queryFactory
//                .select(liked.post, liked.count())
//                .from(liked).distinct()
//                .join(liked.post, post)
//                .where(liked.post.in(posts))
//                .groupBy(liked.post)
//                .fetch();
//
//        log.info(&quot;likedList={}&quot;,  likedList);
//
//        List&lt;Tuple&gt; comments = queryFactory
//                .select(comment.post, comment.count())
//                .from(comment).distinct()
//                .join(comment.post, post)
//                .where(comment.post.in(posts))
//                .groupBy(comment.post)
//                .fetch();
//        log.info(&quot;comments={}&quot;,  comments);
//
//
//
//        double memberCeil = Math.ceil(memberSize / 2.0);
//
//        List&lt;Post&gt; postFilteredFromLikedList = likedList.stream()
//                .filter(m -&gt; m.get(liked.count()) &gt;= memberCeil)
//                .map(m -&gt; m.get(liked.post))
//                .collect(Collectors.toList());
//        log.info(&quot;postFilteredFromLikedList={}&quot;,  postFilteredFromLikedList);
//
//        List&lt;Post&gt; postFilteredFromComments = comments.stream()
//                .filter(m -&gt; m.get(comment.count()) &gt;= memberSize * 2L)
//                .map(m -&gt; m.get(comment.post))
//                .collect(Collectors.toList());
//        log.info(&quot;postFilteredFromComments={}&quot;,  postFilteredFromComments);
//
//        List&lt;Post&gt; intersection = postFilteredFromLikedList.stream()
//                .filter(postFilteredFromComments::contains)
//                .collect(Collectors.toList());
//        log.info(&quot;intersection={}&quot;,  intersection);
//
//        if (intersection.size() &gt; 3) {
//            Collections.shuffle(intersection);
//            List&lt;Post&gt; result = new ArrayList&lt;&gt;();
//            result.add(intersection.get(0));
//            result.add(intersection.get(1));
//            result.add(intersection.get(2));
//            log.info(&quot;result={}&quot;,  result);
//
//            return result;
//        }
////        log.info(&quot;intersection={}&quot;,  intersection);
////        log.info(&quot;intersectionGetId={}&quot;,  intersection.get(0).getId());
//
//        return intersection;
//    }

//    public List&lt;Post&gt; findHotTopicByClub(Club clubRequest,int memberSize) {
////        List&lt;Book&gt; books = queryFactory
////                .select(book)
////                .from(clubBookUser)
////                .join(clubBookUser.book, book)
////                .where(clubBookUser.club.eq(clubRequest),
////                        clubBookUser.book.isNotNull(),
////                        clubBookUser.user.isNotNull())
////                .fetch();
//
//        SaveTime saveTime = new SaveTime();
//        saveTime.setSearchEndDate( LocalDateTime.now());
//        saveTime.setSearchStartDate(LocalDateTime.now().minusWeeks(2));
//
//        log.info(&quot;searchStartDate={}&quot;,  saveTime.getSearchStartDate());
//        log.info(&quot;searchEndDate={}&quot;, saveTime.getSearchEndDate());
//
//
////        List&lt;Post&gt; posts = queryFactory
////                .select(post)
////                .from(post)
////                .where(post.createdDate.between(SaveTime.searchStartDate, SaveTime.searchEndDate),
////                        post.type.eq(PostType.MEMO),
////                        post.book.in(books))
////                .fetch();
//
//        List&lt;Post&gt; posts = queryFactory
//                .select(post)
//                .from(post)
//                .where(post.createdDate.between(saveTime.getSearchStartDate(), saveTime.getSearchEndDate()),
//                        post.type.eq(PostType.TOPIC),
//                        post.book.in(JPAExpressions
//                                .select(book)
//                                .from(clubBookUser)
//                                .join(clubBookUser.book, book)
//                                .where(clubBookUser.club.eq(clubRequest),
//                                        clubBookUser.book.isNotNull(),
//                                        clubBookUser.user.isNotNull())))
//                .fetch();
//
//        log.info(&quot;posts={}&quot;,  posts);
//
//        List&lt;Tuple&gt; likedList = queryFactory
//                .select(liked.post, liked.count())
//                .from(liked).distinct()
//                .join(liked.post, post)
//                .where(liked.post.in(posts))
//                .groupBy(liked.post)
//                .fetch();
//
//        log.info(&quot;likedList={}&quot;,  likedList);
//
//        List&lt;Tuple&gt; comments = queryFactory
//                .select(comment.post, comment.count())
//                .from(comment).distinct()
//                .join(comment.post, post)
//                .where(comment.post.in(posts))
//                .groupBy(comment.post)
//                .fetch();
//        log.info(&quot;comments={}&quot;,  comments);
//
//
//
//        double memberCeil = Math.ceil(memberSize / 2.0);
//
//        List&lt;Post&gt; postFilteredFromLikedList = likedList.stream()
//                .filter(m -&gt; m.get(liked.count()) &gt;= memberCeil)
//                .map(m -&gt; m.get(liked.post))
//                .collect(Collectors.toList());
//        log.info(&quot;postFilteredFromLikedList={}&quot;,  postFilteredFromLikedList);
//
//        List&lt;Post&gt; postFilteredFromComments = comments.stream()
//                .filter(m -&gt; m.get(comment.count()) &gt;= memberSize * 2L)
//                .map(m -&gt; m.get(comment.post))
//                .collect(Collectors.toList());
//        log.info(&quot;postFilteredFromComments={}&quot;,  postFilteredFromComments);
//
//        List&lt;Post&gt; intersection = postFilteredFromLikedList.stream()
//                .filter(postFilteredFromComments::contains)
//                .collect(Collectors.toList());
//        log.info(&quot;intersection={}&quot;,  intersection);
//
//        if (intersection.size() &gt; 3) {
//            Collections.shuffle(intersection);
//            List&lt;Post&gt; result = new ArrayList&lt;&gt;();
//            result.add(intersection.get(0));
//            result.add(intersection.get(1));
//            result.add(intersection.get(2));
//            log.info(&quot;result={}&quot;,  result);
//
//            return result;
//        }
////        log.info(&quot;intersection={}&quot;,  intersection);
////        log.info(&quot;intersectionGetId={}&quot;,  intersection.get(0).getId());
//
//        return intersection;
//    }

    @Data
    class SaveTime {
        @DateTimeFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)
        public LocalDateTime searchStartDate;

        @DateTimeFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)
        public LocalDateTime searchEndDate;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>