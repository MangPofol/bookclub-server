<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">server</a> &gt; <a href="index.source.html" class="el_package">mangpo.server.service.user</a> &gt; <span class="el_source">UserService.java</span></div><h1>UserService.java</h1><pre class="source lang-java linenums">package mangpo.server.service.user;

import java.util.List;
import java.util.Optional;

import lombok.RequiredArgsConstructor;
import mangpo.server.dto.user.ChangePwDto;
import mangpo.server.dto.user.UpdateUserDto;
import mangpo.server.entity.user.Authority;
import mangpo.server.entity.user.User;
import mangpo.server.entity.user.UserAuthority;
import mangpo.server.repository.user.AuthorityRepository;
import mangpo.server.repository.user.UserAuthorityRepository;
import mangpo.server.repository.user.UserRepository;
import mangpo.server.service.common.MailService;
import mangpo.server.util.SecurityUtil;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import javax.persistence.EntityNotFoundException;

@Transactional(readOnly = true)
@RequiredArgsConstructor
@Service
public class UserService {

    private final MailService mailService;

    private final UserRepository userRepository;
    private final AuthorityRepository authorityRepository;
    private final UserAuthorityRepository userAuthorityRepository;

    private final PasswordEncoder passwordEncoder;



//    private final PasswordEncoder passwordEncoder;

//    public UserService(UserRepository userRepository, PasswordEncoder passwordEncoder) {
//        this.userRepository = userRepository;
//        this.passwordEncoder = passwordEncoder;
//    }

//    public UserDto getUserWithAuthorities(String email) {
//        return UserDto.from(userRepository.findWithAuthByEmail(email).orElse(null));
//    }
//
//    public UserDto getMyUserWithAuthorities() {
//        return UserDto.from(SecurityUtil.getCurrentUserId().flatMap(userRepository::findWithAuthByEmail).orElse(null));
//    }

    public User findUserFromToken(){
<span class="nc" id="L54">        Long currentUserId = SecurityUtil.getCurrentUserId();</span>
<span class="nc" id="L55">        return findById(currentUserId);</span>
    }

    @Transactional
    public Long createUser(User user){
<span class="nc" id="L60">        user.changePw(passwordEncoder.encode(user.getPassword()));</span>

<span class="nc" id="L62">        validateDuplicateUser(user.getEmail());</span>
<span class="nc" id="L63">        userRepository.save(user);</span>


//        Authority role = authorityRepository.findById(&quot;ROLE_USER&quot;).get();
<span class="nc" id="L67">        Authority role = authorityRepository.findById(&quot;ROLE_NEED_EMAIL&quot;).get();</span>

<span class="nc" id="L69">        UserAuthority userAuthority = UserAuthority.builder()</span>
<span class="nc" id="L70">                .authority(role)</span>
<span class="nc" id="L71">                .user(user)</span>
<span class="nc" id="L72">                .build();</span>
<span class="nc" id="L73">        userAuthorityRepository.save(userAuthority);</span>

<span class="nc" id="L75">        return user.getId();</span>
    }

    public void validateDuplicateUser(String email) {
<span class="nc bnc" id="L79" title="All 2 branches missed.">        if(email == null)</span>
<span class="nc" id="L80">            return;</span>
<span class="nc" id="L81">        Optional&lt;User&gt; findUser = userRepository.findByEmail(email);</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">        if (findUser.isPresent()){</span>
<span class="nc" id="L83">            throw new IllegalStateException(&quot;이미 사용중인 이메일입니다.&quot;);</span>
        }
<span class="nc" id="L85">    }</span>

<span class="nc" id="L87">    public List&lt;User&gt; findUsers(){ return userRepository.findAll();}</span>

    public User findById(Long userId){
<span class="nc" id="L90">        return userRepository.findById(userId).orElseThrow(() -&gt; new EntityNotFoundException(&quot;존재하지 않는 유저입니다.&quot;));</span>
    }

    public User findUserByEmail(String email){
<span class="nc" id="L94">        return userRepository.findByEmail(email).orElseThrow(() -&gt; new EntityNotFoundException(&quot;존재하지 않는 유저입니다.&quot;));</span>
    }

    @Transactional
    public void updateUser(Long id, UpdateUserDto updateUserDto){
<span class="nc" id="L99">        User user = this.findById(id);</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">        if (!updateUserDto.getEmail().equals(user.getEmail()))</span>
<span class="nc" id="L101">            validateDuplicateUser(updateUserDto.getEmail());</span>

<span class="nc" id="L103">        user.update(updateUserDto);</span>
<span class="nc" id="L104">    }</span>

    @Transactional
    public void deleteUser(Long id){
<span class="nc" id="L108">        User user = userRepository.findById(id).orElseThrow(() -&gt; new EntityNotFoundException(&quot;존재하지 않는 유저입니다.&quot;));</span>

<span class="nc" id="L110">        userRepository.delete(user);</span>
<span class="nc" id="L111">    }</span>

    @Transactional
    public void changeDormant(User user){
<span class="nc" id="L115">        user.changeIsDormant();</span>
<span class="nc" id="L116">    }</span>

    @Transactional
    public void changePassword(ChangePwDto changePwDto){
<span class="nc" id="L120">        User user = this.findUserFromToken();</span>

<span class="nc bnc" id="L122" title="All 2 branches missed.">        if(changePwDto.getPassword() != null)</span>
<span class="nc" id="L123">            user.changePw(passwordEncoder.encode(changePwDto.getPassword()));</span>
<span class="nc" id="L124">    }</span>

    @Transactional
    public void lostPassword(String userEmail){
        //generate random password
<span class="nc" id="L129">        String randomPw = generateRandomPw();</span>

        //send mail
<span class="nc" id="L132">        mailService.lostPw(userEmail, randomPw);</span>

        //change user's pw to new random password
<span class="nc" id="L135">        User user = findUserByEmail(userEmail);</span>
<span class="nc" id="L136">        user.changePw(passwordEncoder.encode(randomPw));</span>
<span class="nc" id="L137">    }</span>

    @Transactional
    public void validateEmail(){
<span class="nc" id="L141">        String randomValidCode = generateRandomValidCode();</span>

<span class="nc" id="L143">        User user = findUserFromToken();</span>
<span class="nc" id="L144">        user.changeEmailValidCode(randomValidCode);</span>

        //send mail
<span class="nc" id="L147">        String userEmail = user.getEmail();</span>
<span class="nc" id="L148">        mailService.validateEmail(userEmail,randomValidCode);</span>
<span class="nc" id="L149">    }</span>

    @Transactional
    public void validateEmailSendCode(String emailValidCode){
<span class="nc" id="L153">        User user = findUserFromToken();</span>

<span class="nc bnc" id="L155" title="All 2 branches missed.">        if (!user.getEmailValidCode().equals(emailValidCode))</span>
<span class="nc" id="L156">            throw new IllegalStateException(&quot;잘못된 인증 코드를 입력했습니다.&quot;);</span>

<span class="nc" id="L158">        user.changeEmailValidCode(null);</span>

<span class="nc" id="L160">        Authority role = authorityRepository.findById(&quot;ROLE_USER&quot;).get();</span>
<span class="nc" id="L161">        UserAuthority userAuthority = userAuthorityRepository.findByUser(user);</span>
<span class="nc" id="L162">        userAuthority.changeAuthority(role);</span>
<span class="nc" id="L163">    }</span>

    private String generateRandomPw() {
<span class="nc" id="L166">        int max = 9999999;</span>
<span class="nc" id="L167">        int min = 1000000;</span>
<span class="nc" id="L168">        int randomNum = (int) ((Math.random() * (max - min)) + min);</span>
<span class="nc" id="L169">        return String.valueOf(randomNum);</span>
    }

    private String generateRandomValidCode() {
<span class="nc" id="L173">        int max = 99;</span>
<span class="nc" id="L174">        int min = 10;</span>
<span class="nc" id="L175">        int randomNum = (int) ((Math.random() * (max - min)) + min);</span>
<span class="nc" id="L176">        return String.valueOf(randomNum);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>