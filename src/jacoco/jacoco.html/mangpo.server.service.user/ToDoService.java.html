<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ToDoService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">server</a> &gt; <a href="index.source.html" class="el_package">mangpo.server.service.user</a> &gt; <span class="el_source">ToDoService.java</span></div><h1>ToDoService.java</h1><pre class="source lang-java linenums">package mangpo.server.service.user;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import mangpo.server.dto.user.ToDoDto;
import mangpo.server.dto.todo.ToDoListCreateDto;
import mangpo.server.dto.todo.ToDoDeleteDto;
import mangpo.server.entity.user.ToDo;
import mangpo.server.entity.user.User;
import mangpo.server.repository.user.ToDoRepository;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import javax.persistence.EntityNotFoundException;
import java.util.List;
import java.util.stream.Collectors;

<span class="nc" id="L18">@Slf4j</span>
@Service
@Transactional(readOnly = true)
@RequiredArgsConstructor
public class ToDoService {

    private final UserService userService;
    private final ToDoRepository toDoRepository;

    @Transactional
    public Long createToDo(ToDoDto toDoDto){
        //여기서 조립하는게 맞는듯.
        // 1.지연로딩 때문이라도 그렇고
        // 2.컨트롤러가 지저분하면 딱 봤을때 햇갈림
        // 3. 조립할때 순서가 필요할일 있기도 함
        // 4. DTO를 넘기니까 재사용성이 좀 떨어진다고 하는데 난 잘 모르겠음
<span class="nc" id="L34">        User user = userService.findUserFromToken();</span>

<span class="nc" id="L36">        ToDo todo = ToDo.builder()</span>
<span class="nc" id="L37">                .user(user)</span>
<span class="nc" id="L38">                .content(toDoDto.getContent())</span>
<span class="nc" id="L39">                .isComplete(Boolean.FALSE)</span>
<span class="nc" id="L40">                .build();</span>

<span class="nc" id="L42">        ToDo save = toDoRepository.save(todo);</span>
<span class="nc" id="L43">        return save.getId();</span>
    }

    @Transactional
    public void updateTodo(Long toDoId,ToDoDto toDoDto){
<span class="nc" id="L48">        ToDo toDo = findById(toDoId);</span>
<span class="nc" id="L49">        toDo.update(toDoDto.getContent(), toDoDto.getIsComplete());</span>
<span class="nc" id="L50">    }</span>

    @Transactional
    public void createToDoList(ToDoListCreateDto toDoListCreateDto){
<span class="nc" id="L54">        User user = userService.findUserFromToken();</span>
<span class="nc" id="L55">        List&lt;String&gt; contents = toDoListCreateDto.getContents();</span>

<span class="nc bnc" id="L57" title="All 2 branches missed.">        for (String content : contents) {</span>
<span class="nc" id="L58">            ToDo toDo = ToDo.builder()</span>
<span class="nc" id="L59">                    .content(content)</span>
<span class="nc" id="L60">                    .build();</span>

<span class="nc" id="L62">            toDo.addUser(user);</span>
<span class="nc" id="L63">        }</span>
<span class="nc" id="L64">    }</span>

    public List&lt;ToDo&gt; findToDos(){
<span class="nc" id="L67">        User user = userService.findUserFromToken();</span>

<span class="nc" id="L69">        return toDoRepository.findByUser(user);</span>
    }

    public ToDo findById(Long toDoId){
<span class="nc" id="L73">        return toDoRepository.findById(toDoId).orElseThrow(() -&gt; new EntityNotFoundException(&quot;존재하지 않는 todo 입니다.&quot;));</span>
    }

    @Transactional
    public void deleteToDos(ToDoDeleteDto toDoDeleteDto){
<span class="nc" id="L78">        User user = userService.findUserFromToken();</span>
<span class="nc" id="L79">        List&lt;Long&gt; request = toDoDeleteDto.getToDoIds();</span>

<span class="nc" id="L81">        List&lt;ToDo&gt; todos = user.getTodos();</span>
<span class="nc" id="L82">        List&lt;Long&gt; todoIds = todos.stream()</span>
<span class="nc" id="L83">                .map(m -&gt; m.getId())</span>
<span class="nc" id="L84">                .collect(Collectors.toList());</span>

<span class="nc bnc" id="L86" title="All 2 branches missed.">        for (Long l : request) {</span>
<span class="nc" id="L87">            int i = todoIds.indexOf(l);</span>
<span class="nc" id="L88">            todoIds.remove(i);</span>
<span class="nc" id="L89">            todos.remove(i);</span>
<span class="nc" id="L90">        }</span>
<span class="nc" id="L91">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>